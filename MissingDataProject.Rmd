---
title: "Missing Data Project"
author: "Karen Cao"
date: "2/1/2019"
output: pdf_document
---
```{r, include = FALSE}
library(dplyr)
library(lubridate)
library(ggplot2)
```

# Data Pre-Processing
```{r, include = FALSE}
# DV: DataValue -> TFR values
# IV: RecallLag
tfr.ini = read.csv(file = "tfr_data.csv", sep = ",")
tfr.ini$year = format(as.Date(format(date_decimal(tfr.ini$TimeMid), "%Y-%m-%d")), "%Y")

tfr.ini =
  tfr.ini %>%
  group_by(Country.or.area, year) %>%
  select(Country.or.area, year, DataValue, RecallLag) %>%
  summarise(DataValue = mean(DataValue), RecallLag = mean(RecallLag)) 

timeline = data_frame(year = rep(1950:2016, each = length(unique(tfr.ini$Country.or.area))))
timeline$Country.or.area = rep(unique(tfr.ini$Country.or.area), 67)

tfr = merge(x = timeline, y = tfr.ini, by = c("Country.or.area", "year"), all.x = TRUE)

# Add two categorical IVs: region & development
reg.dev = read.csv(file = "un_subregion.csv", sep = ",")
dat = merge(x = tfr, y = reg.dev, by = "Country.or.area")

write.csv(dat, file = "tfr_panel_data.csv")

rm(list = ls())
```

```{r, include = FALSE}
# Subset the data to include "India" ONLY
# Subset the data to include only data ranging from 1960 to 2016
dat = read.csv(file = "tfr_panel_data.csv", sep = ",") %>% 
  filter(year >= 1960, Country.or.area == "India")

# Add GDP as a continuous variable (round to 2 decimals)
gdp = read.csv(file.choose(), header = T, skip = 4, sep = ",") 
gdp = gdp %>%
  filter(Country.Name == "India")
gdp = as.numeric(t(gdp))
dat$gdp = round(gdp[!is.na(gdp)][1:57] / 1000000000, 2)

# Recode RecallLag to categorical
dat$RecallLag = abs(dat$RecallLag)
# hist(data$RecallLag)
dat$recall = cut(dat$RecallLag,
                 breaks = c(-Inf, 1, 4, Inf),
                 labels = c("Immediate", "Fast", "Slow"))

dat$DataValue = round(dat$DataValue, 1)

keep = c("DataValue", "year", "gdp", "recall")
dat = dat[ ,keep]
names(dat) = c("TFR", "Year", "GDP", "Recall")

rm(gdp)
rm(keep)

#
dat$TFR_missing = ifelse(is.na(dat$TFR), 0, 1)
dat$Recall_missing = ifelse(is.na(dat$Recall), 0, 1)
```

```{r}
# Function that performs imputation
imp = function(x, method){
  missing = is.na(x)
  x.obs = x[!missing]
  imputed = x
  imputed[missing] <- method(x.obs)
  
  # Output the imputed vector
  return (imputed)
}
```

# Homework 2
## 1. Mean Imputation
Use mean imputation to fill in missing values in variable "TFR".
```{r}
dat$tfr.mean.imp = imp(dat$TFR, method = mean)
ggplot(dat, aes(Year, tfr.mean.imp)) + geom_point()
```

## 2. Mode Imputation
Use mode imputation to fill in missing values in variable "recall".
```{r}
# Functions that performs mode imputation
mode = function(x) {
  ta = table(x)
  tam = max(ta)
  if (all(ta == tam))
    mod = NA
  else
    mod = names(ta)[ta == tam]
  return(mod)
}

dat$recall.mode.imp = imp(dat$Recall, method = mode)

par(mfrow = c(1, 2))
barplot(table(dat$Recall), ylim = c(0, 35))
barplot(table(dat$recall.mode.imp), ylim = c(0, 35))
```

## 3. Analysis
### a) Complete Cases
```{r}
fit1 = lm(TFR ~ Year + GDP + Recall, data = dat)
```

### b) Imputed Data
mean imputation for TFR and mode imputation for Recall.
```{r}
lm(tfr.mean.imp ~ Year + GDP + recall.mode.imp, data = dat)
```

# Homework 3
## 1. Regression Imputation
```{r}
fit1

dat %>%
  filter(is.na(TFR))

```


## 2. Analysis

missingness of the categorical varaible is perfectly correlated with the missingness of the numeric variable(TFR), therefore the two method produce the same results. 